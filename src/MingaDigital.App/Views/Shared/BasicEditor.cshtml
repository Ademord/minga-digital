@using System.Reflection
@using System.ComponentModel
@using System.ComponentModel.DataAnnotations

@{
    var model = (Object)Model;
    var modelType = model.GetType();
    
    var displayProps =
      from prop in modelType.GetProperties()
      let disp = prop.GetCustomAttribute<DisplayAttribute>()
      let readOnly = prop.GetCustomAttribute<ReadOnlyAttribute>()
      where disp != null
      select new
      {
          Name = prop.Name,
          Property = prop,
          ReadOnly = readOnly?.IsReadOnly
      };
    
    var cancelUrl = (String)ViewBag.CancelUrl;
    
    if (cancelUrl == null) { cancelUrl = @Url.Action("Index"); }
}

<div class="entity-editor">
  <h2 class="page-header">
    @ViewBag.Title
  </h2>
  
  <form method="POST">
    @if (!ViewContext.ViewData.ModelState.IsValid)
    {
      <div class="alert alert-danger">
        <h4 class="title">Error</h4>
        @Html.ValidationSummary("")
      </div>
    }
      
    @foreach (var prop in displayProps)
    {
      var isInvalid = ViewContext.ViewData.ModelState[prop.Name]?.Errors.Any();
      var classes = "";
      
      if (isInvalid == true) { classes += " has-error"; }
      
      <div class="form-group @classes">
        @Html.Label(prop.Name, null, new { @class = "control-label" })
        
        @if (prop.ReadOnly == true)
        {
          @Html.TextBox(prop.Name, null, new { disabled = "disabled", @class = "form-control" })
        }
        else
        {
          @Html.Editor(prop.Name)
        }
        
        @*
        <span class="help-block">
          @Html.ValidationMessage(prop.Name)
        </span>
        *@
      </div>
    }
    
    <div class="text-right">
      <a href="@cancelUrl" class="btn btn-link">Cancelar</a>
      
      <button type="submit" class="btn btn-primary">Guardar</button>
    </div>
  </form>
</div>